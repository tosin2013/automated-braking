# Security Guide - Automated Braking Pattern

**Status**: 🔒 Protected with GitLeaks  
**Last Updated**: 2025-10-17

---

## 🔒 Secret Management Strategy

### ✅ What's Safe to Commit

1. **Template Files**
   - `values-secret.yaml.template` ✅ (Contains placeholders only)
   - `*.template` files ✅
   - `*.example` files ✅

2. **Documentation**
   - All `.md` files in `docs/` ✅
   - README files ✅
   - Migration and deployment guides ✅

3. **Helm Chart Default Values**
   - `charts/hub/*/values.yaml` ✅
   - Default passwords marked with "Change in production!" ✅
   - These are overridden by `values-secret.yaml` at runtime

4. **Deprecated Manifests**
   - `manifests/base/` ✅ (Old reference files, not used)

### ❌ What's NEVER Committed

1. **Actual Secrets File**
   - `values-secret.yaml` ❌
   - `values-secret-*.yaml` ❌
   - Location: `~/.config/validatedpatterns/` (outside repo)

2. **Credentials**
   - Database passwords ❌
   - API keys ❌
   - OAuth tokens ❌
   - SSL certificates/keys ❌

3. **Local Configuration**
   - `.mcp-server-context.md` ❌ (contains local paths)
   - `kubeconfig` files ❌
   - `.env` files ❌

---

## 🛡️ GitLeaks Pre-Commit Hook

### Installed Protection

**Hook**: `.git/hooks/pre-commit`  
**Config**: `.gitleaks.toml`  
**Ignore List**: `.gitleaksignore`

### How It Works

Every time you run `git commit`, GitLeaks automatically:
1. ✅ Scans all staged files
2. ✅ Checks for passwords, keys, tokens
3. ✅ Blocks commit if secrets detected
4. ✅ Allows commit if clean

### Test Results
```bash
$ gitleaks detect --verbose --no-git
✅ no leaks found
```

---

## 🔧 Usage

### Normal Commit (Protected)
```bash
git add .
git commit -m "Your message"
# → GitLeaks runs automatically
# → ✅ Commit allowed if no secrets
# → ❌ Commit blocked if secrets found
```

### If GitLeaks Blocks Your Commit

**Option 1: Remove the Secret (Recommended)**
```bash
# Remove or replace the secret
vim path/to/file

# Commit again
git add path/to/file
git commit -m "Fixed: removed secret"
```

**Option 2: Add to Allowlist (If False Positive)**
```bash
# Edit the ignore file
vim .gitleaksignore

# Add the file path or pattern
# Example: charts/hub/minio/values.yaml:rootPassword

# Commit again
git commit -m "Your message"
```

**Option 3: Bypass (NOT RECOMMENDED!)**
```bash
# Only use in emergencies with approval
git commit --no-verify -m "Emergency commit"
```

---

## 📋 Pre-Deployment Security Checklist

### Before First Deployment

- [ ] **Secrets configured**
  ```bash
  ls ~/.config/validatedpatterns/values-secret-automated-braking.yaml
  # Should exist outside the repo
  ```

- [ ] **GitLeaks scan passed**
  ```bash
  cd /home/lab-user/automated-braking
  gitleaks detect --verbose
  # Should show: "no leaks found"
  ```

- [ ] **No hardcoded passwords in charts**
  ```bash
  grep -r "password.*:" charts/hub/*/values.yaml | grep -v "CHANGEME\|comment\|Change in production"
  # Should return nothing or only commented lines
  ```

- [ ] **.gitignore configured**
  ```bash
  cat .gitignore | grep "values-secret"
  # Should show: values-secret.yaml is ignored
  ```

### Before Production Deployment

- [ ] **Change all default passwords**
  - MySQL: `registrypass` → Strong password
  - PostgreSQL: `distancepass` → Strong password
  - MinIO: `minio123` → Strong password

- [ ] **Use strong secrets**
  - Minimum 16 characters
  - Mix of letters, numbers, symbols
  - Generated by password manager

- [ ] **Enable encryption** (Optional but recommended)
  ```bash
  ansible-vault encrypt ~/.config/validatedpatterns/values-secret-automated-braking.yaml
  ```

---

## 🔍 Manual Security Audit

### Scan for Hardcoded Secrets
```bash
# Check for common password patterns
cd /home/lab-user/automated-braking
grep -r "password\|secret\|key" --include="*.yaml" \
  | grep -v ".git\|template\|comment\|Change in production"
```

### Check What Would Be Committed
```bash
# See what git would commit
git status --short

# See actual file contents that would be committed
git diff --cached
```

### Run GitLeaks Manually
```bash
# Scan all files
gitleaks detect --verbose

# Scan only staged files
gitleaks protect --staged --verbose

# Scan specific file
gitleaks detect --source="path/to/file"
```

---

## 📊 Current Security Status

### Protected Files
- ✅ 6 Helm charts with templated secrets
- ✅ values-secret.yaml.template (safe template)
- ✅ All documentation (.md files)
- ✅ Git submodule (common/ framework)

### Ignored Files (Not Committed)
- 🔒 `~/.config/validatedpatterns/values-secret-automated-braking.yaml`
- 🔒 `.mcp-server-context.md`
- 🔒 Local kubeconfig files
- 🔒 Any `values-secret*.yaml` files

### GitLeaks Status
```
✅ Scan completed
✅ No leaks found
✅ Pre-commit hook active
✅ Safe to commit
```

---

## 🚨 Incident Response

### If You Accidentally Commit a Secret

**DO THIS IMMEDIATELY:**

1. **Rotate the compromised secret**
   ```bash
   # Change the password/key immediately
   # Update in ~/.config/validatedpatterns/values-secret-*.yaml
   ```

2. **Remove from Git history** (if pushed)
   ```bash
   # Use BFG Repo-Cleaner or git filter-branch
   # Contact your team lead for assistance
   ```

3. **Verify the secret is gone**
   ```bash
   gitleaks detect --verbose
   git log -p | grep "OLD_PASSWORD"  # Should return nothing
   ```

4. **Document the incident**
   - When it happened
   - What secret was exposed
   - Actions taken
   - Lessons learned

---

## 📚 References

- **GitLeaks**: https://github.com/gitleaks/gitleaks
- **Validated Patterns Secrets**: https://validatedpatterns.io/secrets/
- **Kubernetes Secrets**: https://kubernetes.io/docs/concepts/configuration/secret/
- **OpenShift Secrets**: https://docs.openshift.com/container-platform/latest/nodes/pods/nodes-pods-secrets.html

---

## ✅ Security Best Practices

1. **Never commit secrets** - Use templates and external config
2. **Use GitLeaks** - Automated pre-commit scanning
3. **Rotate regularly** - Change passwords periodically
4. **Least privilege** - Give minimum necessary permissions
5. **Audit logs** - Review who accessed what
6. **Encrypt at rest** - Use Vault or encrypted values
7. **Secure transmission** - Always use TLS/HTTPS
8. **Document everything** - Security procedures and incidents

---

**Security Officer**: AI Architecture Assistant  
**Last Audit**: 2025-10-17  
**GitLeaks Version**: 8.18.4  
**Status**: 🔒 **PROTECTED - Safe to commit**

